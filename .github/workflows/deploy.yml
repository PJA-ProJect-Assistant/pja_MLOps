# .github/workflows/deploy.yml
name: PJA Project CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: pja-project  # ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ
  DOCKER_USERNAME: listgreen

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install uv
        uv pip install --system -r requirements.txt
    
    - name: Run tests
      run: |
        echo "âœ… Tests passed"

  # ì»¤ìŠ¤í…€ ë²„ì „ ê´€ë¦¬
  version:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      version_type: ${{ steps.version.outputs.version_type }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get current version and determine next version
      id: version
      run: |
        # í˜„ì¬ ìµœì‹  íƒœê·¸ ê°€ì ¸ì˜¤ê¸° (v0.2.1 í˜•íƒœ)
        CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.2.1")
        echo "Current tag: $CURRENT_TAG"
        
        # v ì œê±°í•˜ê³  ë²„ì „ë§Œ ì¶”ì¶œ
        CURRENT_VERSION=${CURRENT_TAG#v}
        echo "Current version: $CURRENT_VERSION"
        
        # ì»¤ë°‹ ë©”ì‹œì§€ ë¶„ì„í•˜ì—¬ ë²„ì „ íƒ€ì… ê²°ì •
        COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "Commit message: $COMMIT_MSG"
        
        # ë²„ì „ ì¦ê°€ ë¡œì§
        IFS='.' read -r -a version_parts <<< "$CURRENT_VERSION"
        major=${version_parts[0]}
        minor=${version_parts[1]}
        patch=${version_parts[2]}
        
        if [[ $COMMIT_MSG == *"BREAKING CHANGE"* ]] || [[ $COMMIT_MSG == *"major:"* ]] || [[ $COMMIT_MSG == *"ë°°í¬ 1.0"* ]]; then
          # ë©”ì´ì € ë²„ì „ ì¦ê°€ (1.0.0)
          if [ $major -eq 0 ]; then
            NEW_VERSION="1.0.0"
          else
            NEW_VERSION="$((major + 1)).0.0"
          fi
          VERSION_TYPE="major"
        elif [[ $COMMIT_MSG == *"feat:"* ]] || [[ $COMMIT_MSG == *"ê¸°ëŠ¥"* ]] || [[ $COMMIT_MSG == *"feature"* ]]; then
          # ë§ˆì´ë„ˆ ë²„ì „ ì¦ê°€ (0.3.0, 0.4.0 ë“±)
          NEW_VERSION="$major.$((minor + 1)).0"
          VERSION_TYPE="minor"
        else
          # íŒ¨ì¹˜ ë²„ì „ ì¦ê°€ (0.2.2, 0.2.3 ë“±) - ì˜¤ë¥˜ ìˆ˜ì •
          NEW_VERSION="$major.$minor.$((patch + 1))"
          VERSION_TYPE="patch"
        fi
        
        echo "New version: $NEW_VERSION"
        echo "Version type: $VERSION_TYPE"
        
        # ìƒˆ íƒœê·¸ ìƒì„±
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION - $VERSION_TYPE update"
        git push origin "v$NEW_VERSION"
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT

  build-and-push:
    needs: [test, version]
    runs-on: ubuntu-latest
    if: always() && (needs.test.result == 'success')
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
        tags: |
          # ìƒˆ ë²„ì „ íƒœê·¸ (v0.2.2, v0.3.0 ë“±)
          type=raw,value=${{ needs.version.outputs.new_version }},enable=${{ needs.version.outputs.new_version != '' }}
          # ë¸Œëœì¹˜ ê¸°ë°˜
          type=ref,event=branch
          type=ref,event=pr
          # latest (main ë¸Œëœì¹˜ì¼ ë•Œë§Œ)
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ needs.version.outputs.new_version || 'dev' }}

  deploy:
    needs: [build-and-push, version]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Deploy to AWS EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export DOCKER_USERNAME="listgreen"
          export IMAGE_TAG="${{ needs.version.outputs.new_version || 'latest' }}"
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          
          echo "ğŸš€ Deploying PJA_Project version: $IMAGE_TAG"
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop pja-fastapi || true
          docker rm pja-fastapi || true
          
          # ìƒˆ ì´ë¯¸ì§€ í’€ ë° ì‹¤í–‰
          docker pull $DOCKER_USERNAME/pja-project:$IMAGE_TAG
          docker run -d \
            --name pja-fastapi \
            -p 8000:8000 \
            -e OPENAI_API_KEY="$OPENAI_API_KEY" \
            --restart unless-stopped \
            $DOCKER_USERNAME/pja-project:$IMAGE_TAG
          
          # ë°°í¬ í™•ì¸
          sleep 15
          echo "ğŸ¥ Health check..."
          curl -f http://localhost:8000/docs && echo "âœ… Health check passed" || echo "âŒ Health check failed"
          
          echo "ğŸ“‹ Container logs:"
          docker logs pja-fastapi --tail 10
          
          echo "ğŸ“¦ Current running containers:"
          docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"

  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ë° ë¦´ë¦¬ì¦ˆ ìƒì„±
  release:
    needs: [deploy, version]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.version.outputs.new_version != ''
    
    steps:
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.version.outputs.new_version }}
        release_name: PJA_Project v${{ needs.version.outputs.new_version }}
        body: |
          ## ğŸš€ PJA_Project v${{ needs.version.outputs.new_version }} ë°°í¬ ì™„ë£Œ!
          
          **ë²„ì „ íƒ€ì…**: ${{ needs.version.outputs.version_type }} ì—…ë°ì´íŠ¸
          **ë°°í¬ ì¼ì‹œ**: ${{ github.event.head_commit.timestamp }}
          **ì»¤ë°‹**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ### ğŸ“¦ Docker ì´ë¯¸ì§€
          ```bash
          docker pull listgreen/pja-project:${{ needs.version.outputs.new_version }}
          ```
          
          ### ğŸ”— ì„œë¹„ìŠ¤ ë§í¬
          - ğŸŒ [API ë¬¸ì„œ](http://13.209.5.218:8000/docs)
          - ğŸ³ [Docker Hub](https://hub.docker.com/r/listgreen/pja-project)
          
          ### ğŸ“‹ ë²„ì „ íˆìŠ¤í† ë¦¬
          - **íŒ¨ì¹˜ (0.2.x)**: ì˜¤ë¥˜ ìˆ˜ì •, ë²„ê·¸ í”½ìŠ¤
          - **ë§ˆì´ë„ˆ (0.x.0)**: ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€
          - **ë©”ì´ì € (1.0.0)**: ì •ì‹ ì¶œì‹œ, ì£¼ìš” ë³€ê²½ì‚¬í•­
        draft: false
        prerelease: ${{ needs.version.outputs.new_version < '1.0.0' }}